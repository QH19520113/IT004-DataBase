CREATE DATABASE DE2018_2019_QuanLyDonDatHang
USE DE2018_2019_QuanLyDonDatHang

CREATE TABLE MATHANG
(
	MAMH CHAR(5) CONSTRAINT MH_MAMH_PK PRIMARY KEY,
	TENMH VARCHAR(30) NOT NULL,
	DVT VARCHAR(15),
	NUOCSX VARCHAR(15)
)

CREATE TABLE NHACC
(
	MACC CHAR(5) CONSTRAINT NCC_MACC_PK PRIMARY KEY,
	TENCC VARCHAR(30) NOT NULL,
	DIACHICC VARCHAR(30)
)

CREATE TABLE CUNGCAP
(
	MACC CHAR(5) CONSTRAINT CC_MACC_FK FOREIGN KEY
		REFERENCES NHACC(MACC),
	MAMH CHAR(5) CONSTRAINT CC_MAMH_FK FOREIGN KEY
		REFERENCES MATHANG(MAMH),
	TUNGAY SMALLDATETIME,
	CONSTRAINT CC_MACC_MAMH_PK PRIMARY KEY(MACC, MAMH)
)

CREATE TABLE DONDH
(
	MADH CHAR(5) CONSTRAINT DDH_MADH_PK PRIMARY KEY,
	NGAYDH SMALLDATETIME,
	MACC CHAR(5) CONSTRAINT MH_MAMH_FK FOREIGN KEY
		REFERENCES NHACC(MACC),
	TONGTRIGIA MONEY,
	SOMH INT
)

CREATE TABLE CHITIET
(
	MADH CHAR(5) CONSTRAINT CT_MADH_FK FOREIGN KEY
		REFERENCES DONDH(MADH),
	MAMH CHAR(5) CONSTRAINT CT_MAMH_FK FOREIGN KEY
		REFERENCES MATHANG(MAMH),
	SOLUONG INT,
	DONGIA MONEY,
	TRIGIA MONEY,
	CONSTRAINT CT_MADH_MAMH_PK PRIMARY KEY(MADH, MAMH)
)

INSERT INTO MATHANG VALUES('MH001','Mat hang A', 'DVT 1', 'Trung Quoc')
INSERT INTO MATHANG VALUES('MH002','Mat hang B', 'DVT 1', 'Trung Quoc')
INSERT INTO MATHANG VALUES('MH003','Mat hang C', 'DVT 1', 'Viet Nam')

INSERT INTO NHACC VALUES('CC001','Nha cung cap A','Dia chi A')
INSERT INTO NHACC VALUES('CC002','Nha cung cap B','Dia chi B')

INSERT INTO CUNGCAP VALUES('CC001','MH001','1/12/2019')
INSERT INTO CUNGCAP VALUES('CC002','MH003','2/12/2019')
INSERT INTO CUNGCAP VALUES('CC002','MH002','3/12/2019')

INSERT INTO DONDH VALUES('DH001','1/9/2019','CC001',0 ,2 )
INSERT INTO DONDH VALUES('DH002','2/10/2019','CC001',0 ,2 )

INSERT INTO CHITIET VALUES('DH001', 'MH001', 2, 1000, 2000)
INSERT INTO CHITIET VALUES('DH001', 'MH002', 2, 3000, 6000)
INSERT INTO CHITIET VALUES('DH002', 'MH002', 2, 1000, 2000)

SELECT* FROM CUNGCAP

/*1. Tổng trị giá của đơn đặt hàng bằng tổng các trị giá của các chi tiết đặt hàng thuộc đơn hàng đó*/
GO
CREATE TRIGGER TRG_DONDH_TONGGIATRI_UPD ON DONDH
FOR UPDATE
AS
BEGIN
	DECLARE @TRIGIA MONEY,
			@TONGTRIGIA MONEY,
			@DDH_TONGTRIGIA MONEY,
			@MADH CHAR(5)

	SELECT @MADH = MADH, @DDH_TONGTRIGIA  = TONGTRIGIA
	FROM INSERTED

	SET @TONGTRIGIA = 0

	DECLARE cur_CHITIET CURSOR 
	FOR
		SELECT MADH, TRIGIA
		FROM CHITIET
		WHERE MADH = @MADH

	OPEN cur_CHITIET
	FETCH NEXT FROM cur_CHITIET
	INTO @MADH, @TRIGIA

	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @TONGTRIGIA = @TONGTRIGIA + @TRIGIA
		FETCH NEXT FROM cur_CHITIET
		INTO @MADH, @TRIGIA
	END

	CLOSE cur_CHITIET
	DEALLOCATE cur_CHITIET

	IF(@TONGTRIGIA <> @DDH_TONGTRIGIA)
	BEGIN
		PRINT 'LOI: TONG TRI GIA BANG TONG CAC TRI GIA CUA CAC CHI TIET DAT HANG THUOC DHH DO'
		ROLLBACK TRANSACTION
	END
END
--Kiểm tra Trigger
DROP TRIGGER TRG_DONDH_TONGGIATRI_UPD
UPDATE DONDH
SET TONGTRIGIA = 8000
WHERE MADH = 'DH001'

/*GO -- Chưa được (về del và upd - MAMH)
CREATE TRIGGER TRG_CHITIET_TRIGIA_DEL_INS_UPD ON CHITIET
FOR INSERT, DELETE, UPDATE
AS
BEGIN
	DECLARE @TRIGIA_CU MONEY,
			@TRIGIA_MOI MONEY,
			@MADH CHAR(5)

	SELECT @MADH = MADH, @TRIGIA_CU = TRIGIA
	FROM DELETED

	SELECT @MADH = MADH, @TRIGIA_MOI = TRIGIA
	FROM INSERTED

	IF EXISTS(SELECT* FROM INSERTED) AND EXISTS(SELECT* FROM DELETED)
	BEGIN
		UPDATE DONDH
		SET TONGTRIGIA = TONGTRIGIA - @TRIGIA_CU + @TRIGIA_MOI
		WHERE MADH = @MADH 
		PRINT 'UPDATE CHI TIET DAT HANG THANH CONG'
	END

	IF EXISTS(SELECT* FROM INSERTED) AND NOT EXISTS(SELECT* FROM DELETED)
	BEGIN
		UPDATE DONDH
		SET TONGTRIGIA = TONGTRIGIA + @TRIGIA_MOI
		WHERE MADH = @MADH 
		PRINT 'THEM CHI TIET DAT HANG THANH CONG'
	END

	IF NOT EXISTS(SELECT* FROM INSERTED) AND EXISTS(SELECT* FROM DELETED)
	BEGIN
		UPDATE DONDH
		SET TONGTRIGIA = TONGTRIGIA - @TRIGIA_CU 
		WHERE MADH = @MADH 
		PRINT 'XOA CHI TIET DAT HANG THANH CONG'
	END
END
--Kiểm tra Trigger
SELECT* FROM DONDH WHERE MADH = 'DH001'
SELECT* FROM CHITIET WHERE MADH = 'DH001'
INSERT INTO CHITIET VALUES('DH001','MH003', 2, 500, 1000)
DELETE FROM CHITIET WHERE MAMH = 'MH003'
DELETE FROM CHITIET WHERE MADH = 'DH001'
UPDATE CHITIET
SET TRIGIA =TRIGIA - 100
WHERE MADH = 'DH001' AND MAMH = 'MH002'*/

--Đề 1
/*2a. Danh sách các đơn hàng của tên NCC 'Vinamilk' có TONGTRIGIA > 1.000.000 đồng*/
SELECT MADH, NGAYDH, TONGTRIGIA
FROM NHACC NCC JOIN DONDH DDH ON NCC.MACC = DDH.MACC
WHERE TENCC = 'Vinamilk'
AND TONGTRIGIA > 10000000

/*2b Tính tổng số lượng sản phẩm có MAMH là 'MH001' đã đặng hàng trong năm 2018*/
SELECT SUM(SOLUONG) SOLUONGSP
FROM CHITIET CT JOIN DONDH DDH ON CT.MADH = DDH.MADH
WHERE MAMH = 'MH001' AND YEAR(NGAYDH) = 2018

/*2c Liệt kê những nhà cung cấp(MACC, TENCC) có thể cung cấp những mặt hàng do 'Viet Nam' san xuat
mà không cung cấp những mặt hàng do 'Trung Quoc' sản xuất*/
SELECT NCC.MACC, TENCC
FROM (CUNGCAP CC JOIN NHACC NCC ON CC.MACC = NCC.MACC)
		JOIN MATHANG MH ON MH.MAMH = CC.MAMH
WHERE NUOCSX = 'Viet Nam'
EXCEPT
SELECT NCC.MACC, TENCC
FROM (CUNGCAP CC JOIN NHACC NCC ON CC.MACC = NCC.MACC)
		JOIN MATHANG MH ON MH.MAMH = CC.MAMH
WHERE NUOCSX = 'Trung Quoc'

/*2d Tính tổng số mặt hàng (SOMH) của tất cả các đơn đặt hàng theo từng năm.
Thông tin hiển thị: Năm đặt hàng, Tổng số mặt hàng.*/
SELECT YEAR(NGAYDH) NamDatHang, SUM(SOMH) TongSoMatHang
FROM DONDH
GROUP BY YEAR(NGAYDH)

/*2e Tìm những mã đơn đặt hàng (MADH) đã đặt tất cả các mặt hàng của nhà cung cấp có tên
là 'Vissan'(TENCC).*/ 
SELECT MADH
FROM DONDH DDH
WHERE NOT EXISTS(	SELECT*
					FROM CUNGCAP CC JOIN NHACC NCC ON CC.MACC = NCC.MACC
					WHERE TENCC = 'Vissan'
					AND NOT EXISTS(	SELECT*
									FROM CHITIET CT
									WHERE CT.MAMH = CC.MAMH
									AND CT.MADH = DDH.MADH))


/*2f Tìm những mặt hàng (MAMH, TENMH) có số lượng đặt hàng nhiều nhất trong năm 2018.*/
SELECT TOP 1 WITH TIES MH.MAMH, TENMN
FROM (MATHANG MH JOIN CHITIET CT ON MH.MAMH = CT.MAMH)
		JOIN DONDH DDH ON DDH.MADH = CT.MADH	
WHERE YEAR(NGAYDH) = 2018
GROUP BY MH.MAMH, TENMN
ORDER BY SUM(SOLUONG) DESC


--Đề 2
SELECT NCC.MACC, TENCC, TUNGAY
FROM NHACC NCC JOIN CUNGCAP CC ON NCC.MACC = CC.MACC
WHERE MAMH = 'MH0001'
AND TUNGAY >= '1/1/2018'

SELECT SUM(TRIGIA) TONGTIEN --THANHTIEN
FROM CHITIET CT JOIN DONDH DDH ON CT.MADH = DDH.MADH
WHERE MACC = 'NCC007'
AND MAMH = 'MH014'
GROUP BY MACC, MAMH

SELECT NCC.MACC, TENCC
FROM (NHACC NCC JOIN CUNGCAP CC ON NCC.MACC = CC.MACC)
		JOIN MATHANG MH ON MH.MAMH = CC.MAMH
WHERE NUOCSX = 'Mỹ'
EXCEPT
SELECT NCC.MACC, TENCC
FROM (NHACC NCC JOIN CUNGCAP CC ON NCC.MACC = CC.MACC)
		JOIN MATHANG MH ON MH.MAMH = CC.MAMH
WHERE NUOCSX = 'Hàn Quốc'

SELECT YEAR(NGAYDH) NAM, SUM(TONGTRIGIA) TONGTRIGIA --TRIGIA
FROM DONDH
GROUP BY YEAR(NGAYDH)

SELECT TOP 1 WITH TIES MH.MAMH, TENMN
FROM (MATHANG MH JOIN CHITIET CT ON MH.MAMH = CT.MAMH)
	JOIN DONDH DDH ON DDH.MADH = CT.MADH
WHERE YEAR(NGAYDH) = 2018
GROUP BY MH.MAMH, TENMN
ORDER BY SUM(SOLUONG) ASC

SELECT MADH
FROM DONDH DDH
WHERE NOT EXISTS(	SELECT*
					FROM NHACC NCC JOIN CUNGCAP CC ON NCC.MACC = CC.MACC
					WHERE TENCC = 'Vinamilk'
					AND NOT EXISTS(	SELECT*
									FROM CHITIET CT
									WHERE CT.MADH = DDH.MADH
									AND CC.MAMH = CT.MAMH))
